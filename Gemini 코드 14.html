<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°€ìƒ ì‹¤í—˜: ë¬¼ì§ˆì˜ ìƒíƒœì™€ ì…ì ë°°ì—´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        canvas { border: 4px solid #333; background: #f0f9ff; border-radius: 8px; box-shadow: inset 0 0 20px rgba(0,0,0,0.1); }
        .btn-option { transition: all 0.2s; }
        .btn-option:hover { transform: translateY(-2px); }
        .btn-active { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        .piston { transition: height 0.5s ease-in-out; background: linear-gradient(to bottom, #9ca3af, #4b5563); width: 100%; position: absolute; top: 0; left: 0; opacity: 0.8; border-bottom: 4px solid #1f2937; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-4 flex flex-col items-center">

    <header class="w-full max-w-5xl bg-white rounded-xl shadow-md p-6 mb-6 flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-slate-800"><i class="fas fa-flask text-blue-500 mr-2"></i>ë¬¼ì§ˆì˜ ì„¸ ê°€ì§€ ìƒíƒœ ì‹¤í—˜ì‹¤</h1>
            <p class="text-slate-500 text-sm mt-1">ë‹¨ì›: ë¬¼ì§ˆì˜ ìƒíƒœ ë³€í™” | ëŒ€ìƒ: ì¤‘í•™êµ 1í•™ë…„</p>
        </div>
        <div class="text-right">
            <span class="bg-green-100 text-green-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded">êµìœ¡ê³¼ì • [9ê³¼05-01]</span>
        </div>
    </header>

    <main class="w-full max-w-5xl grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <div class="lg:col-span-2 space-y-4">
            <div class="bg-white p-4 rounded-xl shadow-md relative flex justify-center items-center" id="capture-area">
                <div class="relative">
                    <div id="piston" class="piston h-0"></div> <canvas id="simCanvas" width="500" height="400"></canvas>
                    <div class="absolute bottom-2 left-2 text-xs text-slate-400">View: ì…ì ëª¨í˜•(2D)</div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-md">
                <h3 class="font-bold text-lg mb-4 text-slate-700">ğŸ”¬ ì‹¤í—˜ ì¡°ê±´ ì„¤ì •</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-slate-600">ë¬¼ì§ˆì˜ ìƒíƒœ</label>
                        <div class="flex flex-col gap-2">
                            <button onclick="setMode('solid')" id="btn-solid" class="btn-option w-full py-2 px-4 border rounded hover:bg-blue-50">ğŸ§Š ê³ ì²´</button>
                            <button onclick="setMode('liquid')" id="btn-liquid" class="btn-option w-full py-2 px-4 border rounded hover:bg-blue-50">ğŸ’§ ì•¡ì²´</button>
                            <button onclick="setMode('gas')" id="btn-gas" class="btn-option w-full py-2 px-4 border rounded hover:bg-blue-50">ğŸ’¨ ê¸°ì²´</button>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-slate-600">ìš©ê¸° ëª¨ì–‘</label>
                        <div class="flex flex-col gap-2">
                            <button onclick="setContainer('cube')" id="btn-cube" class="btn-option w-full py-2 px-4 border rounded hover:bg-purple-50">â¬œ ì •ìœ¡ë©´ì²´</button>
                            <button onclick="setContainer('cylinder')" id="btn-cylinder" class="btn-option w-full py-2 px-4 border rounded hover:bg-purple-50">âšª ì›ê¸°ë‘¥(ë¹„ì»¤)</button>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-slate-600">ì™¸ë¶€ ì••ë ¥ (í”¼ìŠ¤í†¤)</label>
                        <button onclick="togglePressure()" id="btn-pressure" class="btn-option w-full h-full py-2 px-4 border-2 border-red-200 rounded text-red-500 font-bold hover:bg-red-50">
                            <i class="fas fa-arrow-down mr-2"></i>í˜ ê°€í•˜ê¸° (OFF)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="space-y-6">
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded shadow-sm">
                <h3 class="font-bold text-blue-700 mb-2">ğŸ‘€ ê´€ì°° í¬ì¸íŠ¸</h3>
                <div id="observation-text" class="text-sm text-slate-700 leading-relaxed">
                    ì‹¤í—˜ì„ ì‹œì‘í•˜ë ¤ë©´ ì™¼ìª½ì—ì„œ ë¬¼ì§ˆì˜ ìƒíƒœë¥¼ ì„ íƒí•˜ì„¸ìš”.
                </div>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-md">
                <h3 class="font-bold text-slate-700 mb-3">ğŸ“Š ìƒíƒœë³„ íŠ¹ì„± ë¹„êµ</h3>
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                        <tr>
                            <th class="px-2 py-2">êµ¬ë¶„</th>
                            <th class="px-2 py-2">ëª¨ì–‘</th>
                            <th class="px-2 py-2">ë¶€í”¼</th>
                        </tr>
                    </thead>
                    <tbody id="stats-table">
                        <tr class="border-b"><td class="px-2 py-2">-</td><td>-</td><td>-</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-xl shadow-md">
                <h3 class="font-bold text-yellow-800 mb-2">ğŸ¤” ìƒê° í€´ì¦ˆ</h3>
                <p id="quiz-question" class="text-sm text-slate-700 mb-3">í”¼ìŠ¤í†¤ì„ ëˆŒë €ì„ ë•Œ ë¶€í”¼ê°€ ê°€ì¥ ë§ì´ ì¤„ì–´ë“œëŠ” ìƒíƒœëŠ” ë¬´ì—‡ì¼ê¹Œìš”?</p>
                <div class="flex gap-2">
                    <button onclick="checkAnswer('solid')" class="bg-white border hover:bg-yellow-100 px-3 py-1 rounded text-xs">ê³ ì²´</button>
                    <button onclick="checkAnswer('liquid')" class="bg-white border hover:bg-yellow-100 px-3 py-1 rounded text-xs">ì•¡ì²´</button>
                    <button onclick="checkAnswer('gas')" class="bg-white border hover:bg-yellow-100 px-3 py-1 rounded text-xs">ê¸°ì²´</button>
                </div>
                <p id="quiz-feedback" class="text-xs font-bold mt-2 text-red-500"></p>
            </div>

            <button onclick="downloadReport()" class="w-full bg-slate-800 text-white py-3 rounded-xl hover:bg-slate-900 shadow-lg">
                <i class="fas fa-file-pdf mr-2"></i>ì‹¤í—˜ ê²°ê³¼ ë¦¬í¬íŠ¸ ì €ì¥
            </button>
        </div>
    </main>

    <script>
        // --- Simulation Variables ---
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        const pistonDiv = document.getElementById('piston');
        
        let particles = [];
        let currentState = 'solid'; // solid, liquid, gas
        let currentContainer = 'cube'; // cube, cylinder
        let isCompressed = false;
        
        const PARTICLE_COUNT = 100;
        const PARTICLE_RADIUS = 6;
        const CANVAS_WIDTH = canvas.width;
        const CANVAS_HEIGHT = canvas.height;

        // --- Particle Class ---
        class Particle {
            constructor() {
                this.reset();
            }

            reset() {
                this.x = Math.random() * (CANVAS_WIDTH - 20) + 10;
                this.y = Math.random() * (CANVAS_HEIGHT - 20) + 10;
                this.vx = (Math.random() - 0.5) * 2;
                this.vy = (Math.random() - 0.5) * 2;
                this.baseX = this.x; // For solid state origin
                this.baseY = this.y;
            }

            update(limitY) {
                // Apply physics based on state
                if (currentState === 'solid') {
                    // Vibrate around base position
                    this.x = this.baseX + (Math.random() - 0.5) * 2; 
                    this.y = this.baseY + (Math.random() - 0.5) * 2;
                    
                    // Solids stick together (mock gravity/structure)
                    if (this.baseY < CANVAS_HEIGHT - 150) this.baseY += 5; // Fall to bottom block
                    
                    // Container Shape Constraint (Mock)
                    if (currentContainer === 'cylinder') {
                        // Push slightly towards center to mimic piling in a round bottom? 
                        // Simplified: Solids hold their own shape mostly.
                    }

                } else if (currentState === 'liquid') {
                    // Flow but stay near bottom
                    this.x += this.vx * 0.5;
                    this.y += this.vy * 0.5 + 0.5; // Slight Gravity

                    // Bounds
                    if (this.x < PARTICLE_RADIUS || this.x > CANVAS_WIDTH - PARTICLE_RADIUS) this.vx *= -1;
                    if (this.y > CANVAS_HEIGHT - PARTICLE_RADIUS) {
                        this.y = CANVAS_HEIGHT - PARTICLE_RADIUS;
                        this.vy *= -0.5; // Dampen
                    }
                    if (this.y < limitY) { // Piston/Compression limit or Surface
                        this.y = limitY + PARTICLE_RADIUS; 
                        this.vy *= -1;
                    }

                } else if (currentState === 'gas') {
                    // Free movement, fast
                    this.x += this.vx * 3;
                    this.y += this.vy * 3;

                    // Bounce off walls and Piston (limitY)
                    if (this.x < PARTICLE_RADIUS || this.x > CANVAS_WIDTH - PARTICLE_RADIUS) this.vx *= -1;
                    if (this.y > CANVAS_HEIGHT - PARTICLE_RADIUS) this.vy *= -1;
                    if (this.y < limitY) {
                        this.y = limitY + PARTICLE_RADIUS;
                        this.vy *= -1;
                    }
                }
            }

            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, PARTICLE_RADIUS, 0, Math.PI * 2);
                ctx.fillStyle = currentState === 'gas' ? '#ef4444' : (currentState === 'liquid' ? '#3b82f6' : '#64748b');
                ctx.fill();
                ctx.closePath();
            }
        }

        // --- Init Particles ---
        function initParticles() {
            particles = [];
            // Calculate grid for solid
            let cols = 10;
            let rows = 10;
            let padding = 15;
            let startX = (CANVAS_WIDTH - (cols * padding)) / 2;
            let startY = CANVAS_HEIGHT - (rows * padding) - 20;

            for (let i = 0; i < PARTICLE_COUNT; i++) {
                let p = new Particle();
                if (currentState === 'solid') {
                    // Arrange in grid
                    let c = i % cols;
                    let r = Math.floor(i / cols);
                    p.baseX = startX + c * padding;
                    p.baseY = startY + r * padding;
                    p.x = p.baseX;
                    p.y = p.baseY;
                }
                particles.push(p);
            }
        }

        // --- Main Animation Loop ---
        function animate() {
            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

            // Draw Container Background hint
            ctx.strokeStyle = '#cbd5e1';
            ctx.lineWidth = 2;
            if (currentContainer === 'cylinder') {
                // Visual hint for cylinder (rounded corners bottom)
                ctx.beginPath();
                ctx.moveTo(50, 0);
                ctx.lineTo(50, CANVAS_HEIGHT - 30);
                ctx.quadraticCurveTo(50, CANVAS_HEIGHT, 80, CANVAS_HEIGHT);
                ctx.lineTo(CANVAS_WIDTH - 80, CANVAS_HEIGHT);
                ctx.quadraticCurveTo(CANVAS_WIDTH - 50, CANVAS_HEIGHT, CANVAS_WIDTH - 50, CANVAS_HEIGHT - 30);
                ctx.lineTo(CANVAS_WIDTH - 50, 0);
                ctx.stroke();
            } else {
                // Cube (Rect)
                ctx.strokeRect(50, 0, CANVAS_WIDTH - 100, CANVAS_HEIGHT);
            }

            // Calculate Piston Level (Compression)
            let limitY = 0;
            if (isCompressed) {
                if (currentState === 'gas') {
                    limitY = CANVAS_HEIGHT / 2; // Gas compresses a lot
                } else {
                    limitY = 50; // Solid/Liquid barely compress, piston stops early
                }
            } else {
                limitY = 0;
            }

            // Animate Piston Visual
            pistonDiv.style.height = isCompressed ? (currentState === 'gas' ? '50%' : '15%') : '0%';
            pistonDiv.style.width = (CANVAS_WIDTH - 100) + 'px';
            pistonDiv.style.left = '50px'; // Align with inner container

            // Update & Draw Particles
            particles.forEach(p => {
                p.update(limitY);
                p.draw();
            });

            requestAnimationFrame(animate);
        }

        // --- Interaction Logic ---
        function setMode(mode) {
            currentState = mode;
            isCompressed = false; // Reset pressure
            updateUI();
            initParticles();
            updateFeedback();
        }

        function setContainer(shape) {
            currentContainer = shape;
            updateUI();
            // In a full physics engine, boundaries would change. 
            // Here we change the visual cue in animate().
        }

        function togglePressure() {
            isCompressed = !isCompressed;
            updateUI();
            updateFeedback();
        }

        function updateUI() {
            // Buttons highlight
            ['solid', 'liquid', 'gas'].forEach(m => {
                const btn = document.getElementById(`btn-${m}`);
                if (m === currentState) btn.classList.add('btn-active');
                else btn.classList.remove('btn-active');
            });

            ['cube', 'cylinder'].forEach(c => {
                const btn = document.getElementById(`btn-${c}`);
                if (c === currentContainer) btn.classList.add('bg-purple-500', 'text-white');
                else btn.classList.remove('bg-purple-500', 'text-white');
            });

            const pBtn = document.getElementById('btn-pressure');
            if (isCompressed) {
                pBtn.innerHTML = '<i class="fas fa-compress-arrows-alt mr-2"></i>ëˆ„ë¥´ëŠ” ì¤‘ (ON)';
                pBtn.classList.add('bg-red-100');
            } else {
                pBtn.innerHTML = '<i class="fas fa-arrow-down mr-2"></i>í˜ ê°€í•˜ê¸° (OFF)';
                pBtn.classList.remove('bg-red-100');
            }
        }

        function updateFeedback() {
            const obsText = document.getElementById('observation-text');
            const tableBody = document.getElementById('stats-table');
            
            let message = "";
            let shapeFixed = "";
            let volFixed = "";

            if (currentState === 'solid') {
                message = "ğŸ§Š **ê³ ì²´ ìƒíƒœ:** ì…ìë“¤ì´ ë§¤ìš° ê·œì¹™ì ìœ¼ë¡œ ë°°ì—´ë˜ì–´ ìˆê³ , ì œìë¦¬ì—ì„œ ì§„ë™ë§Œ í•©ë‹ˆë‹¤. ìš©ê¸°ë¥¼ ë°”ê¿”ë„ ëª¨ì–‘ì´ ë³€í•˜ì§€ ì•Šê³ , ëˆŒëŸ¬ë„ ë¶€í”¼ê°€ ê±°ì˜ ë³€í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
                shapeFixed = "ì¼ì •í•¨";
                volFixed = "ì¼ì •í•¨";
            } else if (currentState === 'liquid') {
                message = "ğŸ’§ **ì•¡ì²´ ìƒíƒœ:** ì…ìë“¤ì´ ë¹„êµì  ììœ ë¡­ê²Œ ì›€ì§ì´ë©° í˜ëŸ¬ë‚´ë¦½ë‹ˆë‹¤. ë‹´ëŠ” ìš©ê¸°ì— ë”°ë¼ ëª¨ì–‘ì€ ë³€í•˜ì§€ë§Œ, ì…ì ì‚¬ì´ ê°„ê²©ì´ ì¢ì•„ ë¶€í”¼ëŠ” ê±°ì˜ ë³€í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
                shapeFixed = "ë³€í•¨";
                volFixed = "ì¼ì •í•¨";
            } else if (currentState === 'gas') {
                message = "ğŸ’¨ **ê¸°ì²´ ìƒíƒœ:** ì…ìë“¤ì´ ë§¤ìš° ë¹ ë¥´ê²Œ ì›€ì§ì´ë©° í¼ì ¸ ë‚˜ê°‘ë‹ˆë‹¤. ìš©ê¸°ë¥¼ ê°€ë“ ì±„ìš°ë¯€ë¡œ ëª¨ì–‘ê³¼ ë¶€í”¼ê°€ ëª¨ë‘ ì¼ì •í•˜ì§€ ì•Šìœ¼ë©°, **ì••ë ¥ì„ ê°€í•˜ë©´ ë¶€í”¼ê°€ ì‰½ê²Œ ì¤„ì–´ë“­ë‹ˆë‹¤!**";
                shapeFixed = "ë³€í•¨";
                volFixed = "ë³€í•¨ (ì••ì¶• ê°€ëŠ¥)";
            }

            obsText.innerHTML = message;
            
            // Update table
            if(isCompressed) {
                // If compressed, highlight the change
                tableBody.innerHTML = `
                    <tr class="border-b bg-blue-50 font-bold">
                        <td class="px-2 py-2">${currentState === 'solid' ? 'ê³ ì²´' : (currentState === 'liquid' ? 'ì•¡ì²´' : 'ê¸°ì²´')}</td>
                        <td class="px-2 py-2">${shapeFixed}</td>
                        <td class="px-2 py-2 text-red-600">${volFixed}</td>
                    </tr>
                `;
            } else {
                tableBody.innerHTML = `
                    <tr class="border-b">
                        <td class="px-2 py-2">${currentState === 'solid' ? 'ê³ ì²´' : (currentState === 'liquid' ? 'ì•¡ì²´' : 'ê¸°ì²´')}</td>
                        <td class="px-2 py-2">${shapeFixed}</td>
                        <td class="px-2 py-2">${volFixed}</td>
                    </tr>
                `;
            }
        }

        // --- Quiz & Download ---
        function checkAnswer(ans) {
            const feedback = document.getElementById('quiz-feedback');
            if (ans === 'gas') {
                feedback.innerHTML = "â­• ì •ë‹µì…ë‹ˆë‹¤! ê¸°ì²´ëŠ” ì…ì ì‚¬ì´ì˜ ê±°ë¦¬ê°€ ë§¤ìš° ë©€ê¸° ë•Œë¬¸ì— ì••ë ¥ì„ ê°€í•˜ë©´ ê·¸ ë¹ˆ ê³µê°„ì´ ì¤„ì–´ë“¤ì–´ ë¶€í”¼ê°€ í¬ê²Œ ë³€í•©ë‹ˆë‹¤.";
                feedback.className = "text-xs font-bold mt-2 text-green-600";
            } else {
                feedback.innerHTML = "âŒ ë‹¤ì‹œ ìƒê°í•´ë³´ì„¸ìš”. ì…ìë“¤ì´ ì´ë¯¸ ë¹½ë¹½í•˜ê²Œ ëª¨ì—¬ìˆëŠ” ìƒíƒœëŠ” ëˆ„ë¥¼ ê³µê°„ì´ ì—†ë‹µë‹ˆë‹¤.";
                feedback.className = "text-xs font-bold mt-2 text-red-500";
            }
        }

        async function downloadReport() {
            const { jsPDF } = window.jspdf;
            
            // Create canvas screenshot
            const canvasElement = document.querySelector("#capture-area");
            const canvasImage = await html2canvas(canvasElement).then(c => c.toDataURL("image/png"));
            
            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.text("ê³¼í•™ ê°€ìƒ ì‹¤í—˜ ë¦¬í¬íŠ¸", 20, 20);
            doc.setFontSize(12);
            doc.text(`ì‹¤í—˜ ì£¼ì œ: ë¬¼ì§ˆì˜ ìƒíƒœ ë³€í™” ([9ê³¼05-01])`, 20, 30);
            doc.text(`ì‹¤í—˜ ì¼ì‹œ: ${new Date().toLocaleString()}`, 20, 40);
            
            doc.text("1. ì‹¤í—˜ ê²°ê³¼ ì´ë¯¸ì§€:", 20, 50);
            doc.addImage(canvasImage, 'PNG', 20, 60, 100, 80);
            
            doc.text("2. ë‚˜ì˜ ê´€ì°° ìš”ì•½:", 20, 150);
            let summary = "";
            if(currentState === 'solid') summary = "- ê³ ì²´ëŠ” ê·œì¹™ì ì¸ ë°°ì—´ì„ ê°€ì§€ë©° ëª¨ì–‘ê³¼ ë¶€í”¼ê°€ ì¼ì •í•˜ë‹¤.";
            if(currentState === 'liquid') summary = "- ì•¡ì²´ëŠ” íë¥´ëŠ” ì„±ì§ˆì´ ìˆì–´ ëª¨ì–‘ì€ ë³€í•˜ì§€ë§Œ ë¶€í”¼ëŠ” ì¼ì •í•˜ë‹¤.";
            if(currentState === 'gas') summary = "- ê¸°ì²´ëŠ” ë§¤ìš° ììœ ë¡œìš°ë©° ì••ë ¥ì— ë”°ë¼ ë¶€í”¼ê°€ ì‰½ê²Œ ë³€í•œë‹¤.";
            
            doc.text(summary, 20, 160);
            doc.text("- ì…ì ëª¨í˜•ì„ í†µí•´ ëˆˆì— ë³´ì´ì§€ ì•ŠëŠ” ì…ì ë°°ì—´ì„ í™•ì¸í–ˆë‹¤.", 20, 170);

            doc.save("ì‹¤í—˜ê²°ê³¼_ë¦¬í¬íŠ¸.pdf");
            alert("ê²°ê³¼ ë¦¬í¬íŠ¸ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!");
        }

        // Start
        initParticles();
        setMode('solid');
        setContainer('cube');
        animate();

    </script>
</body>
</html>
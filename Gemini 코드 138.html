<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í™”í•™ ë°˜ì‘ ì†ë„ ê°€ìƒ ì‹¤í—˜ì‹¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f0f4f8; }
        .canvas-container { position: relative; width: 100%; height: 300px; background: white; border-radius: 8px; border: 2px solid #e2e8f0; overflow: hidden; }
        .highlight { color: #2563eb; font-weight: bold; }
        /* ìŠ¬ë¼ì´ë” ìŠ¤íƒ€ì¼ */
        input[type=range] { width: 100%; }
    </style>
</head>
<body class="text-gray-800">

    <header class="bg-blue-600 text-white p-4 shadow-lg">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold">ğŸ§ª í™”í•™ ë°˜ì‘ ì†ë„ ì‹¤í—˜ì‹¤</h1>
                <p class="text-sm opacity-90">í™”í•™â…¡: ë°˜ì‘ë¬¼ê³¼ ìƒì„±ë¬¼ì˜ ë†ë„ ë³€í™”ì™€ í‰ê·  ë°˜ì‘ ì†ë„</p>
            </div>
            <div class="text-right text-sm">
                <p>ëª©í‘œ: ê·¸ë˜í”„ì˜ ê¸°ìš¸ê¸°ë¥¼ í†µí•´ ë°˜ì‘ ì†ë„ ì´í•´í•˜ê¸°</p>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-4 gap-6 grid grid-cols-1 lg:grid-cols-3">
        
        <div class="lg:col-span-1 space-y-4">
            <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
                <h2 class="font-bold text-lg mb-3 border-b pb-2">âš™ï¸ ì‹¤í—˜ ì¡°ì‘</h2>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ë°˜ì‘ ìœ í˜• ì„ íƒ</label>
                    <select id="reactionType" class="w-full border rounded p-2 text-sm bg-gray-50">
                        <option value="1">1ì°¨ ë°˜ì‘ (A â†’ B)</option>
                        <option value="2">ê°€ìƒì˜ ë¹ ë¥¸ ë°˜ì‘ (2A â†’ B)</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ë°˜ì‘ ì†ë„ ìƒìˆ˜ (k)</label>
                    <input type="range" id="rateConstant" min="0.05" max="0.3" step="0.01" value="0.1" class="accent-blue-600">
                    <div class="text-right text-xs text-gray-500">ëŠë¦¼ <span id="kValueDisplay">0.1</span> ë¹ ë¦„</div>
                </div>

                <div class="flex gap-2">
                    <button onclick="startSimulation()" id="btnStart" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 rounded font-bold transition">â–¶ ë°˜ì‘ ì‹œì‘</button>
                    <button onclick="resetSimulation()" id="btnReset" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded font-bold transition">â†º ì´ˆê¸°í™”</button>
                </div>
            </div>

            <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="font-bold text-lg">ğŸ” ì…ì ëª¨í˜• (Micro)</h2>
                    <span class="text-sm bg-gray-100 px-2 py-1 rounded">Time: <span id="timerDisplay" class="text-red-600 font-bold">0.0</span>s</span>
                </div>
                <div class="canvas-container" id="simContainer">
                    <canvas id="particleCanvas"></canvas>
                </div>
                <div class="flex justify-center gap-4 mt-2 text-sm">
                    <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-red-500 mr-1"></span> ë°˜ì‘ë¬¼ A: <span id="countA" class="font-mono font-bold ml-1">100</span></div>
                    <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-blue-500 mr-1"></span> ìƒì„±ë¬¼ B: <span id="countB" class="font-mono font-bold ml-1">0</span></div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-2 space-y-4">
            <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
                <h2 class="font-bold text-lg mb-2">ğŸ“ˆ ì‹œê°„-ë†ë„ ê·¸ë˜í”„ (Macro)</h2>
                <div class="relative h-64 w-full">
                    <canvas id="chartCanvas"></canvas>
                </div>
                <p class="text-xs text-gray-500 mt-2 text-center">* ê·¸ë˜í”„ì˜ ê¸°ìš¸ê¸°ê°€ ê°€íŒŒë¥¼ìˆ˜ë¡ ë°˜ì‘ ì†ë„ê°€ ë¹ ë¦…ë‹ˆë‹¤.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white p-4 rounded-lg shadow border border-gray-200 h-64 overflow-y-auto">
                    <h2 class="font-bold text-md mb-2">ğŸ“Š ì‹¤í—˜ ë°ì´í„°</h2>
                    <table class="w-full text-sm text-center border-collapse">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="p-2 border">ì‹œê°„(s)</th>
                                <th class="p-2 border text-red-600">[A]</th>
                                <th class="p-2 border text-blue-600">[B]</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                            </tbody>
                    </table>
                </div>

                <div class="bg-blue-50 p-4 rounded-lg shadow border border-blue-200">
                    <h2 class="font-bold text-md mb-3 text-blue-800">ğŸ§® í‰ê·  ë°˜ì‘ ì†ë„ ê³„ì‚°</h2>
                    <p class="text-xs text-gray-600 mb-2">ì›í•˜ëŠ” ì‹œê°„ êµ¬ê°„ì„ ì…ë ¥í•˜ì—¬ í‰ê·  ì†ë„ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
                    
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-sm">êµ¬ê°„:</span>
                        <input type="number" id="t1" class="w-12 p-1 border rounded text-center" placeholder="0">ì´ˆ ~ 
                        <input type="number" id="t2" class="w-12 p-1 border rounded text-center" placeholder="5">ì´ˆ
                    </div>
                    
                    <button onclick="calculateRate()" class="w-full bg-blue-600 text-white py-1 rounded text-sm hover:bg-blue-700 mb-3">ê³„ì‚°í•˜ê¸°</button>
                    
                    <div id="resultBox" class="hidden bg-white p-3 rounded border border-blue-200 text-sm">
                        <p><strong>Î”t:</strong> <span id="resDt"></span>ì´ˆ</p>
                        <p><strong>Î”[A]:</strong> <span id="resDA"></span> (ê°ì†Œ)</p>
                        <p class="mt-1 border-t pt-1"><strong>í‰ê·  ë°˜ì‘ ì†ë„:</strong></p>
                        <p class="text-lg text-center text-blue-700 font-bold"><span id="resRate"></span> ê°œ/ì´ˆ</p>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- ì„¤ì • ë³€ìˆ˜ ---
        const PARTICLE_COUNT = 100;
        const SIM_DURATION = 20; // 20ì´ˆ
        let particles = [];
        let time = 0;
        let running = false;
        let animationId;
        let reactionRateK = 0.1;
        let dataHistory = [];
        let chartInstance = null;

        // --- DOM ìš”ì†Œ ---
        const canvas = document.getElementById('particleCanvas');
        const ctx = canvas.getContext('2d');
        const countADisplay = document.getElementById('countA');
        const countBDisplay = document.getElementById('countB');
        const timerDisplay = document.getElementById('timerDisplay');
        const dataTableBody = document.getElementById('dataTableBody');

        // --- ìº”ë²„ìŠ¤ ì„¤ì • ---
        function resizeCanvas() {
            canvas.width = document.getElementById('simContainer').offsetWidth;
            canvas.height = document.getElementById('simContainer').offsetHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // --- ì…ì í´ë˜ìŠ¤ ---
        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.vx = (Math.random() - 0.5) * 2;
                this.vy = (Math.random() - 0.5) * 2;
                this.type = 'A'; // A: Red, B: Blue
                this.radius = 4;
            }

            move() {
                this.x += this.vx;
                this.y += this.vy;

                // ë²½ ì¶©ëŒ
                if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
                if (this.y < 0 || this.y > canvas.height) this.vy *= -1;
            }

            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = this.type === 'A' ? '#ef4444' : '#3b82f6'; // Tailwind Red-500, Blue-500
                ctx.fill();
                ctx.closePath();
            }
        }

        // --- ê·¸ë˜í”„ ì´ˆê¸°í™” (Chart.js) ---
        function initChart() {
            const ctxChart = document.getElementById('chartCanvas').getContext('2d');
            chartInstance = new Chart(ctxChart, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'ë°˜ì‘ë¬¼ [A]', data: [], borderColor: '#ef4444', tension: 0.4 },
                        { label: 'ìƒì„±ë¬¼ [B]', data: [], borderColor: '#3b82f6', tension: 0.4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 0 },
                    scales: {
                        x: { title: { display: true, text: 'ì‹œê°„ (ì´ˆ)' }, max: 20 },
                        y: { title: { display: true, text: 'ì…ì ìˆ˜ (ê°œ)' }, min: 0, max: 100 }
                    }
                }
            });
        }

        // --- ì‹œë®¬ë ˆì´ì…˜ ë¡œì§ ---
        function initSimulation() {
            particles = [];
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                particles.push(new Particle());
            }
            time = 0;
            dataHistory = [{t:0, a:100, b:0}];
            updateDisplay();
            updateTable(0, 100, 0, true);
            
            // ê·¸ë˜í”„ ë¦¬ì…‹
            if(chartInstance) {
                chartInstance.data.labels = [0];
                chartInstance.data.datasets[0].data = [100];
                chartInstance.data.datasets[1].data = [0];
                chartInstance.update();
            } else {
                initChart();
            }
        }

        function updateDisplay() {
            const countA = particles.filter(p => p.type === 'A').length;
            const countB = particles.filter(p => p.type === 'B').length;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => {
                p.move();
                p.draw();
            });

            countADisplay.innerText = countA;
            countBDisplay.innerText = countB;
            timerDisplay.innerText = time.toFixed(1);
        }

        function runLoop() {
            if (!running) return;

            // 1. ì‹œê°„ ì¦ê°€
            time += 0.05; // í”„ë ˆì„ë‹¹ ì‹œê°„ (ê°€ì†)

            // 2. ë°˜ì‘ ë¡œì§ (1ì°¨ ë°˜ì‘ ì†ë„ë¡  ê¸°ë°˜ í™•ë¥ ì  ë³€í™˜)
            // A -> B í™•ë¥ : P = 1 - e^(-k*dt)
            // ê°„ë‹¨í•œ ì‹œë®¬ë ˆì´ì…˜ì„ ìœ„í•´ ê° í”„ë ˆì„ë§ˆë‹¤ í™•ë¥  ì²´í¬
            const prob = reactionRateK * 0.05; 
            
            particles.forEach(p => {
                if (p.type === 'A' && Math.random() < prob) {
                    p.type = 'B';
                }
            });

            // 3. ë°ì´í„° ê¸°ë¡ (0.5ì´ˆ ë‹¨ìœ„)
            if (Math.floor(time * 10) % 5 === 0) { // 0.5ì´ˆë§ˆë‹¤
                const countA = particles.filter(p => p.type === 'A').length;
                const countB = PARTICLE_COUNT - countA;
                
                // ë°ì´í„° ì¤‘ë³µ ë°©ì§€ (ê°„ë‹¨í•œ ì²˜ë¦¬)
                if (dataHistory.length === 0 || dataHistory[dataHistory.length-1].t < Math.floor(time * 2)/2) {
                    const currentTime = parseFloat(time.toFixed(1));
                    dataHistory.push({ t: currentTime, a: countA, b: countB });
                    
                    // ê·¸ë˜í”„ ì—…ë°ì´íŠ¸
                    chartInstance.data.labels.push(currentTime);
                    chartInstance.data.datasets[0].data.push(countA);
                    chartInstance.data.datasets[1].data.push(countB);
                    chartInstance.update();

                    // í…Œì´ë¸” ì—…ë°ì´íŠ¸
                    updateTable(currentTime, countA, countB);
                }
            }

            updateDisplay();

            if (time >= SIM_DURATION || particles.every(p => p.type === 'B')) {
                running = false;
                document.getElementById('btnStart').innerText = "â–¶ ë°˜ì‘ ì¢…ë£Œ";
                return;
            }

            animationId = requestAnimationFrame(runLoop);
        }

        function updateTable(t, a, b, clear=false) {
            if(clear) dataTableBody.innerHTML = '';
            const row = `<tr><td class="border p-1">${t}</td><td class="border p-1 text-red-600 font-bold">${a}</td><td class="border p-1 text-blue-600 font-bold">${b}</td></tr>`;
            dataTableBody.insertAdjacentHTML('afterbegin', row); // ìµœì‹  ë°ì´í„° ìœ„ë¡œ
        }

        // --- ì»¨íŠ¸ë¡¤ëŸ¬ ---
        function startSimulation() {
            if (running) return;
            if (time >= SIM_DURATION) resetSimulation();
            
            running = true;
            document.getElementById('btnStart').innerText = "Running...";
            reactionRateK = parseFloat(document.getElementById('rateConstant').value);
            runLoop();
        }

        function resetSimulation() {
            running = false;
            cancelAnimationFrame(animationId);
            document.getElementById('btnStart').innerText = "â–¶ ë°˜ì‘ ì‹œì‘";
            initSimulation();
            document.getElementById('resultBox').classList.add('hidden');
        }

        // --- ê³„ì‚° ë¡œì§ ---
        function calculateRate() {
            const t1 = parseFloat(document.getElementById('t1').value);
            const t2 = parseFloat(document.getElementById('t2').value);

            if (isNaN(t1) || isNaN(t2) || t1 >= t2) {
                alert("ì˜¬ë°”ë¥¸ ì‹œê°„ êµ¬ê°„ì„ ì…ë ¥í•˜ì„¸ìš” (t1 < t2)");
                return;
            }

            // ê°€ì¥ ê°€ê¹Œìš´ ë°ì´í„° í¬ì¸íŠ¸ ì°¾ê¸°
            const d1 = dataHistory.reduce((prev, curr) => Math.abs(curr.t - t1) < Math.abs(prev.t - t1) ? curr : prev);
            const d2 = dataHistory.reduce((prev, curr) => Math.abs(curr.t - t2) < Math.abs(prev.t - t2) ? curr : prev);

            const dt = d2.t - d1.t;
            const da = d2.a - d1.a; // ë‚˜ì¤‘ - ì²˜ìŒ (ìŒìˆ˜ ë‚˜ì˜´)
            
            // ë°˜ì‘ ì†ë„ = -Î”[A] / Î”t
            const rate = -(da / dt);

            document.getElementById('resDt').innerText = dt.toFixed(1);
            document.getElementById('resDA').innerText = Math.abs(da);
            document.getElementById('resRate').innerText = rate.toFixed(2);
            document.getElementById('resultBox').classList.remove('hidden');
        }

        // ìŠ¬ë¼ì´ë” ê°’ í‘œì‹œ
        document.getElementById('rateConstant').addEventListener('input', (e) => {
            document.getElementById('kValueDisplay').innerText = e.target.value;
        });

        // ì´ˆê¸° ì‹¤í–‰
        initSimulation();

    </script>
</body>
</html>
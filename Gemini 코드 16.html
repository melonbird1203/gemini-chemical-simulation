<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°€ìƒ ì‹¤í—˜ì‹¤: ìƒíƒœ ë³€í™”ì™€ ê¸ˆì† í™œì</title>
    <style>
        :root {
            --primary: #4A90E2;
            --success: #2ECC71;
            --warning: #F1C40F;
            --danger: #E74C3C;
            --text: #333;
            --bg: #F5F7FA;
            --panel-bg: #FFFFFF;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 0;
            color: var(--text);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Header */
        header {
            background-color: var(--primary);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        h1 { margin: 0; font-size: 1.5rem; }
        .step-indicator { font-weight: bold; background: rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 20px; }

        /* Main Layout */
        main {
            display: flex;
            flex: 1;
            padding: 20px;
            gap: 20px;
            height: calc(100vh - 80px);
            box-sizing: border-box;
        }

        /* Panels */
        .panel {
            background: var(--panel-bg);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        /* Left: Controls */
        #control-panel {
            flex: 1;
            min-width: 250px;
            max-width: 300px;
            justify-content: space-between;
        }

        .guide-box {
            background: #eef2f7;
            border-left: 5px solid var(--primary);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .control-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        
        input[type="range"] { width: 100%; cursor: pointer; }
        
        button {
            width: 100%;
            padding: 12px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s;
        }
        button:hover { background-color: #357ABD; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* Center: Simulation Canvas */
        #sim-panel {
            flex: 2;
            position: relative;
            background: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        canvas {
            border: 2px solid #eee;
            border-radius: 10px;
            background: #fdfdfd;
        }

        /* Right: Particle View & Data */
        #data-panel {
            flex: 1;
            min-width: 250px;
            max-width: 300px;
        }

        #particle-view {
            width: 100%;
            height: 200px;
            background: #222;
            border-radius: 10px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .data-display {
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .status-tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .status-solid { background-color: var(--primary); }
        .status-liquid { background-color: var(--danger); }
        .status-mixed { background-color: var(--warning); color: #333; }

        /* Overlay for Result */
        #result-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        .result-img { width: 150px; height: 150px; background: #ddd; margin: 20px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 3rem; }

    </style>
</head>
<body>

<header>
    <h1>ğŸ§ª ê°€ìƒ ì‹¤í—˜ì‹¤: ê¸ˆì† í™œì(ë¹„ëˆ„) ë§Œë“¤ê¸°</h1>
    <div class="step-indicator" id="step-display">ë‹¨ê³„ 1: ìœµí•´ (ë…¹ì´ê¸°)</div>
</header>

<main>
    <section class="panel" id="control-panel">
        <div>
            <h2>ì‹¤í—˜ ì œì–´</h2>
            <div class="guide-box" id="guide-text">
                ë¹„ì»¤ì— ê³ ì²´ ë¹„ëˆ„ê°€ ë‹´ê²¨ ìˆìŠµë‹ˆë‹¤.<br>
                <b>ì˜¨ë„ ìŠ¬ë¼ì´ë”</b>ë¥¼ ì˜¬ë ¤ ë¹„ëˆ„ë¥¼ ë…¹ì—¬ë³´ì„¸ìš”.
            </div>

            <div class="control-group" id="heat-controls">
                <label for="temp-slider">ì˜¨ë„ ì¡°ì ˆ (<span id="temp-val">20</span>Â°C)</label>
                <input type="range" id="temp-slider" min="20" max="100" value="20">
            </div>

            <div class="control-group" id="cool-controls" style="display:none;">
                <label>ëƒ‰ê° ì§„í–‰ë„: <span id="cool-val">0</span>%</label>
                <progress id="cool-progress" value="0" max="100" style="width:100%"></progress>
            </div>
        </div>

        <button id="action-btn" disabled>ë‹¤ìŒ ë‹¨ê³„: ê±°í‘¸ì§‘ì— ë¶“ê¸°</button>
    </section>

    <section class="panel" id="sim-panel">
        <canvas id="mainCanvas" width="500" height="400"></canvas>
        
        <div id="result-overlay">
            <h2>âœ¨ í™œì ì œì‘ ì„±ê³µ!</h2>
            <div class="result-img">å­—</div>
            <p id="result-desc">ì™„ë²½í•˜ê²Œ ì‘ê³ ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            <button onclick="location.reload()" style="width:auto; padding: 10px 30px;">ë‹¤ì‹œ ì‹¤í—˜í•˜ê¸°</button>
        </div>
    </section>

    <section class="panel" id="data-panel">
        <h2>ğŸ”¬ ì…ì í˜„ë¯¸ê²½</h2>
        <div id="particle-view">
            <canvas id="particleCanvas" width="260" height="200"></canvas>
        </div>
        
        <div class="data-display">
            <p>í˜„ì¬ ìƒíƒœ: <span id="state-badge" class="status-tag status-solid">ê³ ì²´ (Solid)</span></p>
            <p>ì…ì ìš´ë™: <span id="kinetic-energy">ë§¤ìš° ì•½í•¨ (ì§„ë™)</span></p>
            <hr>
            <p style="font-size: 0.85rem; color: #666;">
                ğŸ’¡ <b>Tip:</b> <br>
                ê³ ì²´ëŠ” ì…ìê°€ ê·œì¹™ì ìœ¼ë¡œ ë°°ì—´ë˜ì–´ ìˆê³ , ì•¡ì²´ëŠ” ë¶ˆê·œì¹™í•˜ê²Œ ííŠ¸ëŸ¬ì§‘ë‹ˆë‹¤.
            </p>
        </div>
    </section>
</main>

<script>
    /**
     * Simulation State Management
     */
    const state = {
        step: 0, // 0: Heating, 1: Pouring, 2: Cooling, 3: Result
        temp: 20,
        isMelting: false,
        isLiquid: false,
        coolingProgress: 0,
        particles: []
    };

    const CONSTANTS = {
        MELTING_POINT: 60,
        SOLID_COLOR: "#E0F7FA",
        LIQUID_COLOR: "#81D4FA",
        MOLD_COLOR: "#D7CCC8"
    };

    // DOM Elements
    const els = {
        tempSlider: document.getElementById('temp-slider'),
        tempVal: document.getElementById('temp-val'),
        actionBtn: document.getElementById('action-btn'),
        guideText: document.getElementById('guide-text'),
        stepDisplay: document.getElementById('step-display'),
        heatControls: document.getElementById('heat-controls'),
        coolControls: document.getElementById('cool-controls'),
        coolVal: document.getElementById('cool-val'),
        coolProgress: document.getElementById('cool-progress'),
        stateBadge: document.getElementById('state-badge'),
        kineticText: document.getElementById('kinetic-energy'),
        resultOverlay: document.getElementById('result-overlay')
    };

    // Canvas Setup
    const mainCanvas = document.getElementById('mainCanvas');
    const mainCtx = mainCanvas.getContext('2d');
    const pCanvas = document.getElementById('particleCanvas');
    const pCtx = pCanvas.getContext('2d');

    /**
     * Particle System Logic
     */
    class Particle {
        constructor(x, y) {
            this.originX = x;
            this.originY = y;
            this.x = x;
            this.y = y;
            this.vx = (Math.random() - 0.5) * 2;
            this.vy = (Math.random() - 0.5) * 2;
        }

        update(temp, isConfined) {
            const energy = (temp - 20) / 80; // 0.0 to 1.0

            if (temp < CONSTANTS.MELTING_POINT) {
                // Solid Mode: Vibrate around origin
                const vibration = energy * 2; 
                this.x = this.originX + (Math.random() - 0.5) * vibration;
                this.y = this.originY + (Math.random() - 0.5) * vibration;
            } else {
                // Liquid Mode: Move freely
                const speed = energy * 3;
                this.x += this.vx * speed;
                this.y += this.vy * speed;

                // Bounds checking
                if (this.x < 0 || this.x > pCanvas.width) this.vx *= -1;
                if (this.y < 0 || this.y > pCanvas.height) this.vy *= -1;

                // Return to grid if cooling down drastically (simplified)
                if(isConfined) {
                     this.x += (this.originX - this.x) * 0.1;
                     this.y += (this.originY - this.y) * 0.1;
                }
            }
        }

        draw(ctx) {
            ctx.beginPath();
            ctx.arc(this.x, this.y, 4, 0, Math.PI * 2);
            ctx.fillStyle = state.temp < CONSTANTS.MELTING_POINT ? "#4A90E2" : "#E74C3C";
            ctx.fill();
        }
    }

    // Initialize Particles
    function initParticles() {
        state.particles = [];
        const rows = 6;
        const cols = 8;
        const spacingX = pCanvas.width / (cols + 1);
        const spacingY = pCanvas.height / (rows + 1);

        for(let i=0; i<rows; i++) {
            for(let j=0; j<cols; j++) {
                state.particles.push(new Particle(spacingX * (j+1), spacingY * (i+1)));
            }
        }
    }

    /**
     * Main Simulation Loop
     */
    function drawSimulation() {
        mainCtx.clearRect(0, 0, mainCanvas.width, mainCanvas.height);
        
        // Draw Heater
        mainCtx.fillStyle = "#333";
        mainCtx.fillRect(150, 300, 200, 50);
        if(state.temp > 30 && state.step === 0) {
            mainCtx.fillStyle = `rgba(231, 76, 60, ${(state.temp-20)/100})`;
            mainCtx.font = "20px Arial";
            mainCtx.fillText("â™¨ï¸", 240, 335);
        }

        if (state.step === 0) { // Heating Stage
            // Beaker
            mainCtx.strokeStyle = "#aaa";
            mainCtx.lineWidth = 4;
            mainCtx.strokeRect(200, 150, 100, 150);
            
            // Soap Content
            const isLiq = state.temp >= CONSTANTS.MELTING_POINT;
            mainCtx.fillStyle = isLiq ? CONSTANTS.LIQUID_COLOR : CONSTANTS.SOLID_COLOR;
            
            if(isLiq) {
                // Liquid level
                mainCtx.fillRect(205, 200, 90, 95);
                // Bubbles
                if(state.temp > 80) {
                     mainCtx.beginPath();
                     mainCtx.arc(230 + Math.random()*40, 220 + Math.random()*50, 3, 0, Math.PI*2);
                     mainCtx.fillStyle = "white";
                     mainCtx.fill();
                }
            } else {
                // Solid Block
                mainCtx.fillRect(210, 220, 80, 75);
            }

        } else if (state.step === 2) { // Cooling Stage (In Mold)
            // Mold
            mainCtx.fillStyle = CONSTANTS.MOLD_COLOR;
            mainCtx.fillRect(180, 200, 140, 80); // Outside
            mainCtx.fillStyle = "#fff"; // Cavity background (not visible if filled)
            
            // Soap in Mold
            const solidity = state.coolingProgress / 100; // 0(Liquid) -> 1(Solid)
            // Interpolate color from Liquid Blue to Solid Blue
            mainCtx.fillStyle = solidity > 0.8 ? CONSTANTS.SOLID_COLOR : CONSTANTS.LIQUID_COLOR;
            mainCtx.fillRect(190, 210, 120, 60);

            // Label
            mainCtx.fillStyle = "#333";
            mainCtx.font = "14px Noto Sans KR";
            mainCtx.fillText("ê±°í‘¸ì§‘(Mold)", 210, 300);
        }

        // Particle View Draw
        pCtx.fillStyle = "rgba(0,0,0,0.3)";
        pCtx.fillRect(0,0, pCanvas.width, pCanvas.height);
        
        state.particles.forEach(p => {
            // If cooling, confine particles back to grid
            const isConfined = (state.step === 2);
            // Simulate temp drop during cooling
            let currentTemp = state.step === 2 ? (100 - state.coolingProgress) : state.temp;
            
            p.update(currentTemp, isConfined);
            p.draw(pCtx);
        });

        requestAnimationFrame(drawSimulation);
    }

    /**
     * Interaction Handlers
     */
    els.tempSlider.addEventListener('input', (e) => {
        state.temp = parseInt(e.target.value);
        els.tempVal.textContent = state.temp;
        updateStateInfo();
    });

    els.actionBtn.addEventListener('click', () => {
        if (state.step === 0) {
            // Transition to Cooling (Skip pouring anim for brevity in this code)
            state.step = 2; 
            setupCooling();
        } else if (state.step === 2) {
            // Finish
            state.step = 3;
            els.resultOverlay.style.display = "flex";
        }
    });

    function updateStateInfo() {
        if (state.step === 0) {
            if (state.temp >= CONSTANTS.MELTING_POINT) {
                state.isLiquid = true;
                els.stateBadge.className = "status-tag status-liquid";
                els.stateBadge.textContent = "ì•¡ì²´ (Liquid) - ìœµí•´ë¨";
                els.kineticText.textContent = "í™œë°œí•¨ (ìœ ë™ì„± ìˆìŒ)";
                els.guideText.innerHTML = "ë¹„ëˆ„ê°€ ë…¹ì•˜ìŠµë‹ˆë‹¤! ì´ì œ <b>'ë‹¤ìŒ ë‹¨ê³„'</b>ë¥¼ ëˆŒëŸ¬ ê±°í‘¸ì§‘ì— ë¶€ìœ¼ì„¸ìš”.";
                els.actionBtn.disabled = false;
            } else {
                state.isLiquid = false;
                els.stateBadge.className = "status-tag status-solid";
                els.stateBadge.textContent = "ê³ ì²´ (Solid)";
                els.kineticText.textContent = "ì•½í•¨ (ì œìë¦¬ ì§„ë™)";
                els.guideText.innerHTML = "ì˜¨ë„ë¥¼ ë” ë†’ì—¬ì„œ ë¹„ëˆ„ë¥¼ ì™„ì „íˆ ë…¹ì—¬ì•¼ í•©ë‹ˆë‹¤. (ë…¹ëŠ”ì : 60Â°C)";
                els.actionBtn.disabled = true;
            }
        }
    }

    function setupCooling() {
        // UI Change
        els.heatControls.style.display = 'none';
        els.coolControls.style.display = 'block';
        els.stepDisplay.textContent = "ë‹¨ê³„ 2: ì‘ê³  (êµ³íˆê¸°)";
        els.guideText.innerHTML = "ëœ¨ê±°ìš´ ë¹„ëˆ„ì•¡ì„ ê±°í‘¸ì§‘ì— ë¶€ì—ˆìŠµë‹ˆë‹¤.<br>ì‹œê°„ì´ ì§€ë‚˜ë©´ ì—´ì„ ë°©ì¶œí•˜ë©° êµ³ìŠµë‹ˆë‹¤.";
        els.actionBtn.textContent = "í™œì êº¼ë‚´ê¸° (ì™„ì„±)";
        els.actionBtn.disabled = true;

        // Auto Cooling Logic
        let coolInterval = setInterval(() => {
            if (state.coolingProgress < 100) {
                state.coolingProgress += 1;
                els.coolVal.textContent = state.coolingProgress;
                els.coolProgress.value = state.coolingProgress;
                
                // Update Badge
                if (state.coolingProgress > 50) {
                    els.stateBadge.className = "status-tag status-solid";
                    els.stateBadge.textContent = "ê³ ì²´ (Solid) - ì‘ê³ ë¨";
                    els.kineticText.textContent = "ë‹¤ì‹œ ê·œì¹™ì ìœ¼ë¡œ ë°°ì—´ë¨";
                }
            } else {
                clearInterval(coolInterval);
                els.guideText.innerHTML = "ì™„ì „íˆ êµ³ì—ˆìŠµë‹ˆë‹¤! ì´ì œ í™œìë¥¼ êº¼ë‚´ë³´ì„¸ìš”.";
                els.actionBtn.disabled = false;
            }
        }, 100); // Cooling Speed
    }

    // Init
    initParticles();
    drawSimulation();

</script>

</body>
</html>